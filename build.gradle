buildscript {
    repositories {
        maven { url 'http://repo.springsource.org/plugins-release' }
    }
    dependencies {
        classpath 'org.springframework.build.gradle:propdeps-plugin:0.0.3'
    }
}

description = 'ElasticSearch Hadoop'
group = 'org.elasticsearch.hadoop'

repositories {
  mavenCentral()
  maven { url "http://oss.sonatype.org/content/groups/public/" }
  // JDO ec2 missing from Maven Central
  maven { url "http://www.datanucleus.org/downloads/maven2" }
  maven { url "http://repository.cloudera.com/artifactory/cloudera-repos/" }
}

apply plugin: "java"
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'propdeps'
apply plugin: 'propdeps-idea'
apply plugin: 'propdeps-eclipse'

def List hadoop = []
def hadoopDistro = project.hasProperty("distro") ? project.getProperty("distro") : "hadoop10"
def hadoopVersion = hadoop10Version

// default is Hadoop 1.0.x
switch (hadoopDistro) {

  // Cloudera CDH4
  case "cdh4":
    hadoopVersion = cdh4Version
    println "Using Cloudera CDH4 [$hadoopVersion]"

    dependencies {
		optional("org.apache.hadoop:hadoop-client:$hadoopVersion");
    }

    hiveVersion = cdh4HiveVersion
    pigVersion = cdh4PigVersion
    thriftVersion = cdh4ThriftVersion

  break;

  // Hadoop 1.1.x
  case "hadoop11":
    hadoopVersion = hadoop11Version
    println "Using Apache Hadoop 1.1.x [$hadoopVersion]"
    hadoop = ["org.apache.hadoop:hadoop-streaming:$hadoopVersion",
              "org.apache.hadoop:hadoop-tools:$hadoopVersion"]

  break;

  default:
    println "Using Apache Hadoop 1.0.x [$hadoopVersion]"
    hadoopVersion = hadoop10Version
    hadoop = ["org.apache.hadoop:hadoop-streaming:$hadoopVersion",
              "org.apache.hadoop:hadoop-tools:$hadoopVersion"]
}

dependencies {
	compile hadoop
	
	optional("commons-io:commons-io:2.1")
	compile("org.codehaus.jackson:jackson-mapper-asl:1.8.8")
    testRuntime("log4j:log4j:$log4jVersion")

    // Pig
    optional("org.apache.pig:pig:$pigVersion")

	ext.hiveGroup = "org.apache.hive"
    // Hive
    optional("$hiveGroup:hive-service:$hiveVersion")
    
    // needed by the Hive Server tests
    testRuntime "$hiveGroup:hive-builtins:$hiveVersion" 

    // Libs dependencies (specified to cope with incompatibilities between them)
    testRuntime "org.antlr:antlr-runtime:$antlrVersion"

    // Testing
    testCompile "junit:junit:$junitVersion"
    
	// Required by Pig
	testRuntime "com.google.guava:guava:11.0"
	testRuntime "dk.brics.automaton:automaton:1.11-8"
    // specify a version of antlr that works with both hive and pig (works only during compilation)
    testRuntime "org.antlr:antlr-runtime:$antlrVersion"
}

// exclude poms from the classpath (pulled in by Cloudera)
eclipse.classpath.file {
    whenMerged { classpath ->
        classpath.entries.removeAll { entry -> entry.toString().contains(".pom") }
    }
}

sourceCompatibility = 1.6
targetCompatibility = 1.6 

ext.skipPig = true
ext.skipHive = true

task enablePigTests {
    description = "Enable Pig tests"
    group = "Verification"
    
    doLast() {
        project.ext.skipPig = false
   }
}

task enableHiveTests {
    description = "Enable Hive tests"
    group = "Verification"
    doLast() {
        project.ext.skipHive = false
   }
}

task enableAllTests() {
    description = "Enable all (incl. Pig, Hive) tests"
    group = "Verification"
    doFirst() {
      println "Enable all tests"
      project.ext.skipPig = false
      project.ext.skipHive = false
    }
}

test {
    systemProperties['input.path'] = 'build/classes/test/input'
    systemProperties['output.path'] = 'build/classes/test/output'
    includes = ["**/*.class"]

    testLogging {
        events "started"
        minGranularity 2
        maxGranularity 2
    }

    doFirst() {
        ext.msg = ""
        
        if (skipPig) {
            ext.msg += "Pig "
            excludes.add("**/pig/**")
        }
        if (skipHive) {
            ext.msg += "Hive"
            excludes.add("**/hive/**")
        }

        if (!msg.isEmpty())
            println "Skipping [$msg] Tests";
	}
}

task sourcesJar(type: Jar, dependsOn:classes) {
    classifier = 'sources'
    from sourceSets.main.allJava
}

task javadocJar(type: Jar) {
    classifier = 'javadoc'
    from javadoc
}

artifacts {
    archives sourcesJar
    archives javadocJar
}

task wrapper(type: Wrapper) {
    description = 'Generates gradlew[.bat] scripts'
    gradleVersion = '1.4'
}

assemble.dependsOn = ['jar', 'sourcesJar']
defaultTasks 'build'